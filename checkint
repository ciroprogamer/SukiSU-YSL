#!/bin/bash
echo "=== Init.rc Injection Diagnostic ==="

echo "[1] Check if KERNEL_SU_RC is defined properly..."
cd ~/kernel_xiaomi_ysl
grep -A 20 "KERNEL_SU_RC\[\]" KernelSU/kernel/ksud.c

echo ""
echo "[2] Check if init.rc hook is enabled..."
grep -rn "ksu_init_rc_hook" KernelSU/kernel/ksud.c

echo ""
echo "[3] Check init.rc hook variable state..."
grep -B 5 -A 5 "bool ksu_init_rc_hook" KernelSU/kernel/ksud.c

echo ""
echo "[4] On device - check if init sees the KSU service..."
adb shell su -c "getprop | grep -i ksu"

echo ""
echo "[5] Check if init.rc contains KSU additions..."
adb shell su -c "cat /init.rc 2>/dev/null | grep -A 5 'post-fs-data' | grep -i ksud || echo 'KSU RC NOT FOUND IN INIT.RC'"

echo ""
echo "[6] Check dmesg for init.rc injection..."
adb shell su -c "dmesg | grep -i 'init.*rc\|ksu.*rc\|append'"

echo ""
echo "[7] Check if read_proxy is being called..."
adb shell su -c "dmesg | grep -i 'read_proxy\|ksu_rc'"

echo ""
echo "[8] Check KERNEL_SU_DOMAIN definition..."
cd ~/kernel_xiaomi_ysl
grep -rn "KERNEL_SU_DOMAIN" KernelSU/

echo ""
echo "[9] Check KSUD_PATH definition..."
grep -rn "KSUD_PATH" KernelSU/

echo ""
echo "[10] Check if hook is disabled at runtime..."
adb shell su -c "dmesg | grep 'stop.*hook\|disable.*hook'"

echo "=== Done ==="
